@use 'utilities' as *;

@forward 'typography';
@forward 'fonts';
@forward 'links';

@forward 'layout';



#Main {
	// Base spacing.
	> * {
		margin-top: var(--typography--line--4);

		&:first-child { margin-top: initial }
	}

	blockquote,
	ol,
	p,
	pre,
	ul {
		margin-top: var(--typography--line);

		&:first-child { margin-top: initial }
	}

	// Mixin to leverage the cascade.
	@mixin double-after { + * { margin-top: var(--typography--line--2) } }



	%--sticky-header--main {
		@extend %sticky-header;

		--sticky--chin:     var(--typography--line-height);
		--sticky--forehead: var(--typography--line);
		--sticky--top:      calc(var(--sticky--first) + var(--typography--cap) / var(--typography--scale, 1)); // Nav above.

		z-index: 1; // In front of siblings.

		@include width(568) {
			--sticky--forehead: var(--typography--line-height);
			--sticky--top:    0;

			@include browser(chrome) { --sticky--top: -0.01rem } // Prevent visible sliver above.

			@include width(744) {
				@include tall(480) {
					--sticky--chin:     var(--typography--line);
					--sticky--forehead: var(--typography--line);
				}
			}
		}
	}



	a {
		@extend %link--text;

		--color: var(--color--secondary);

		code {
			border-color:        transparent;
			border-left-width:   0;
			border-right-width:  0;
			border-style:        solid;
			box-shadow:          initial;
			display:             inline;
			margin:              initial;
			padding:             initial;

			&:before, &:after { content: '\2002' } // An `&ensp;` around it.
		}

		&:has(> code) { --typography--underline--shift: -0.333 } // Below the background.
	}



	blockquote {
		--color: var(--color--secondary);

		padding-left:  var(--typography--lead);
		padding-right: var(--typography--lead);
		position:      relative;

		@include double-after;

		a { // Down one more notch.
			--color:            var(--color--tertiary);
			--color--underline: var(--color--middle);
		}

		// The rarer nested ones, also down a notch.
		blockquote,
		strong {
			--color: var(--color--tertiary);
		}

		s {
			--color:            var(--color--tertiary);
			--color--underline: var(--color--primary);
		}

		blockquote,
		ol,
		pre
		ul {
			margin-left:   var(--typography--lead);
			padding-right: initial;
		}

		code { --color: var(--color--primary) }

		// The bar on the side.
		&:before {
			background-color: var(--color--middle);
			content:          '';
			height:           100%;
			left:             0;
			min-height:       calc(var(--typography--cap) + var(--typography--lead));
			position:         absolute;
			top:              50%;
			transform:        translateY(-50%); // Center single-line bar on text.
			width:            var(--typography--stroke);

			// Chrome rounds up for the width, but not for borders.
			@include browser (chrome) {
				background-color:  initial;
				border-left-color: var(--color--middle);
				border-left-style: solid;
				border-left-width: var(--typography--stroke);
			}
		}
	}



	s {
		@extend %typography--inline;
		@extend %typography--strikethrough;

		--color:            var(--color--secondary);
		--color--underline: var(--color--primary);
	}

	strong,
	sup {
		@extend %font--extended;
		@extend %font--gill-sans--in-verdana;
		@extend %font--uppercase;
		@extend %typography--inline;
	}

	strong { --color: var(--color--secondary) }

	sup {
		--typography--scale: 0.9; // Optical.

		margin-left:     0.125em;
		vertical-align:  calc(var(--typography--x) / var(--typography--scale));
		// Sat on top of Verdana x-height.

		> a {
			@extend %typography--underline--disable;

			--color: var(--color--tertiary);
		}
	}



	code {
		@extend %font--sf-mono--in-verdana;

		--color: var(--color--hover);

		background-color: var(--color--slight);
		border-radius:    var(--link--radius);
		overflow-x:       auto;
		overflow-y:       hidden;
		white-space:      pre;

		&::-webkit-scrollbar { display: none }
	}

	*:not(pre) > code { // Inline-only.
		@extend %typography--inline-block;

		--padding: 0.4em; // Optical.

		-webkit-user-select: all;
		margin-left:         var(--typography--margin--left);
		margin-right:        var(--typography--margin--right);
		max-width:           calc(100% - 0.333em); // Cut last letter at full width.
		padding-left:        calc(var(--padding) + var(--typography--margin--left));
		padding-right:       calc(var(--padding) + var(--typography--margin--right));
		box-shadow:          inset 0 calc(-1 * var(--typography--margin--top) - var(--padding)) var(--color--background),
		                     inset 0 calc(var(--typography--margin--bottom)   + var(--padding)) var(--color--background);
		// “Shadow” draws over the top/bottom of the too-tall background.
	}

	pre {
		display:  flex; // Tighten right edge to content.
		tab-size: 2;

		code {
			@extend %typography;

			margin-bottom:  calc(-1 * var(--typography--lead));
			margin-left:    initial; // From typography.
			margin-right:   initial;
			margin-top:     calc(-1 * var(--typography--lead));
			max-width:      100%;
			padding-bottom: var(--typography--lead);
			padding-left:   calc(var(--typography--lead) + var(--typography--margin--left));
			padding-right:  calc(var(--typography--lead) + var(--typography--margin--right));
			padding-top:    var(--typography--lead);
		}
	}



	ol,
	ul {
		display:             flex;
		flex-direction:      column;
		list-style-position: outside;
		padding-left:        var(--list--marker-shift); // Declared below.
		padding-right:       calc(var(--typography--lead) + var(--list--marker-shift));
		row-gap:             var(--typography--lead);

		@include double-after;

		> li {
			display:       list-item;
			margin-bottom: var(--typography--margin--bottom);
			margin-top:    var(--typography--margin--top);
			padding-left:  calc(var(--typography--lead) - var(--list--item-shift));

			&:before, &:after { display: none } // Conflicts with the marker, so use the margin.

			// Since the `li` is an acting type element.
			> p {
				margin-left:  initial;
				margin-right: initial;

				// Take off top one and bottom one.
				&:first-child:before, &:last-child:after { display: none }
			}

			// Nested last paragraph margin “collapses” up.
			> blockquote > p:last-child { margin-bottom: calc(-1 * var(--typography--margin--bottom)) }

			> blockquote,
			> ol,
			> p,
			> pre,
			> ul {
				// Extra line after nested block elements..
				&:last-child { margin-bottom: var(--typography--line-height) }

				// Two extra for multiple.
				&:not(:only-child):last-child { margin-bottom: calc(var(--typography--line-height) * 2) }
			}

			// Cancel these out for the last list items.
			&:last-child > *:last-child { margin-bottom: initial }
		}
	}

	ol {
		--list--marker-shift: 1.31em; // Left edge of Gill ‘7’ bar.
		--list--item-shift:   0.67em; // Optical.

		list-style-type: decimal;

		li::marker {
			@extend %font--gill-sans--on-verdana; // 😎.
			@extend %typography--inline;

			color: var(--color--tertiary);
		}

		@include browser(chrome) { // Sigh.
			--list--marker-shift: 1.02em;
			--list--item-shift:   0.37em;
		}

		&:has(> :nth-child(10)) { // Fancy new selector to shift these in further.
			--list--marker-shift: 1.84em;

			@include browser(chrome) { --list--marker-shift: 1.55em }
		}
	}

	ul {
		--list--marker-shift: 0.51em; // Align the bullet edge, at least in Safari.
		--list--item-shift:   0.16em; // Optical.

		list-style-type: '•';

		li::marker { color: var(--color--middle) }

		@include browser(chrome) { --list--marker-shift: 0.55em } // What can you do.
	}



	h1 { @extend %font--gill-sans--x-verdana-cap }



	.dateline {
		@extend %font--extended;
		@extend %font--gill-sans--on-verdana;
		@extend %font--uppercase;

		--color: var(--color--middle);

		@include double-after;
	}

	.permalink {
		@extend %typography--underline--disable;

		--color: var(--color--middle);

		// Add gap, cancel out the `&nbsp;`, enlargement, and letter-spacing.
		margin-left: calc(var(--typography--lead) - 1ch - var(--link--enlargement) + (var(--typography--inset--right--override) * 1em));

		@include hover { --color: var(--color--hover) } // Specificity.
	}

	.smallprint {
		@extend %font--extended;
		@extend %font--gill-sans--in-verdana;
		@extend %font--uppercase;

		--color: var(--color--tertiary);

		margin-top: var(--typography--line--2);

		em { font-style: normal } // Cancel these out in favor of small caps. (Gill itals are way off.)
	}



	> .linkedlist {
		display:        flex;
		flex-direction: column;
		row-gap:        var(--typography--line--4);

		> div { // New container from JS.
			> dt {
				@extend %--sticky-header--main;
				@extend %font--extended;
				@extend %font--gill-sans--on-verdana;
				@extend %font--uppercase;

				--color: var(--color--secondary);

				@include double-after;

				> a { @extend %typography--underline--disable }
			}
		}
	}



	> .article {
		> h1 {
			@extend %--sticky-header--main;

			@include double-after;

			> a {
				@extend %typography--underline--disable;

				--color: var(--color--primary);
			}
		}

		> h2 {
			@extend %font--extended;
			@extend %font--gill-sans--on-verdana;
			@extend %font--uppercase;

			margin-top: var(--typography--line--4);

			@include double-after;
		}



		> .footnotes {
			--color: var(--color--secondary);

			margin-top: var(--typography--line--4);

			> ol {
				margin-top:  calc(-1 * var(--typography--line));
				padding-top: var(--typography--line);
				position:    relative;

				&:before { // Lil’ bar.
					background-color: var(--color--middle);
					content:          '';
					height:           var(--typography--stroke);
					left:             0;
					position:         absolute;
					top:              0;
					width:            33%;

					@include width(568) { width: 25% }
				}

				> hr { display: none } // Easier to use the pseudo.

				> li {
					a {
						--color: var(--color--tertiary);

						@include hover { --color: var(--color--hover) } // Specificity.
					}

					code { --color: var(--color--primary) }

					.footnoteBackLink { // The return arrow.
						@extend %typography--underline--disable;

						line-height:     1em; // For vertical-align.
						vertical-align: -0.15em;

						@include browser(safari--mobile) {
							font-family:    -apple-system; // Slightly better arrow.
							font-size:       170%;
							vertical-align: -0.125em;
						}
					}
				}
			}
		}
	}



	> .ookiaks {
		display: none;

		+ * {
			margin-top: var(--typography--line--6);

			// Smoke em’ if you got em.
			@include width(744) { @include tall(1080) { margin-top: var(--typography--line--8) } }
		}
	}



	> .archive {
		#SiteSearch {
			@extend %--sticky-header--main;

			// Inline style again, #sorrynotsorry.
			margin-bottom: calc(-1 * var(--sticky--chin) - var(--sticky--fade)) !important;
		}

		> h1 { margin-top: var(--typography--line--2) }

		> h2 {
			@extend .dateline;

			margin-top: var(--typography--line--4);
		}

		> p {
			@extend %font--gill-sans--x-verdana-x;

			margin-top: var(--typography--line);
			max-width:  48ch;

			> a {
				@extend %typography--underline--disable;

				--color: var(--color--primary);
			}

			> small {
				@extend %font--extended;
				@extend %font--gill-sans--in-verdana;
				@extend %font--uppercase;
				@extend %typography--inline-block;

				--color: var(--color--tertiary);

				width: 100%; // Force onto new line.
			}
		}
	}



	#MainMartini {
		margin-top: var(--typography--line--2);

		&:not(:last-child) { margin-bottom: var(--typography--line--2) }
	}



	#PreviousNext {
		margin-top: var(--typography--line--4);

		table {
			width: 100%;

			tr:not(:first-child) td { padding-top: var(--typography--line) } // Second row. Oh, tables.

			td:first-child { // Prev/next.
				padding-right: var(--typography--lead);
				text-align:    right;

				@include width(744) { @include tall(480) { padding-right: var(--typography--line) } }
			}

			td:not(:first-child) { // Article titles.
				@extend %font--gill-sans--x-verdana-x;

				width: 100%;

				a {
					@extend %typography--underline--disable;

					--color: var(--color--primary);
				}
			}
		}
	}



	#SiteSearch {
		margin-bottom: initial !important; // To override inline styles, I’m sorry.

		> div {
			align-items:   start;
			display:       flex;
			gap:           var(--typography--lead);
			margin-bottom: var(--typography--margin--bottom);
			margin-top:    var(--typography--margin--top);

			input[name='q'] {
				@extend %link--element;

				--color--highlight:       var(--color--slight); // Override active states.
				--color--highlight--more: var(--color--slight);

				@include hover { --color--slight: var(--color--middle) }

				background-color: var(--color--slight);
				border-radius:    var(--link--radius);
				cursor:           text;
				flex-grow:        1;
				font-size:        85%;
				margin-bottom:    initial;
				margin-right:     initial !important; // I swear I wouldn’t do this otherwise.
				margin-top:       initial;
				margin:           initial;
				max-width:        66%;
				padding-bottom:   initial;
				padding-top:      initial;
				width:            initial !important; // I’m not proud of this.

				@include width(568) { max-width: 50% }
			}

			input[type='submit'] {
				@extend %font--extended;
				@extend %font--gill-sans--on-verdana;
				@extend %font--uppercase;
				@extend %link--element;
				@extend %typography;

				--color: var(--color--secondary);

				margin-bottom:  initial;
				margin-top:     initial;
				padding-bottom: initial;
				padding-right:  calc(var(--link--enlargement) + var(--typography--margin--right));
				padding-top:    initial;
			}
		}
	}



	#Footer {
		--footer--gap: var(--typography--line--4);

		display:         flex;
		flex-direction:  column;
		flex-grow:       1; // For shorter pages, fill the space.
		justify-content: end; // And push the contents down.
		margin-top:      var(--footer--gap);

		.smallprint:not(:first-child) {
			margin-top: var(--typography--line);

			// Hide prefs link and extra breaks.
			> a[href='/preferences/'], > br { display: none }
		}

		@include width(744) {
			@include tall(480)  { --footer--gap: var(--typography--line--6) }
			@include tall(1080) { --footer--gap: var(--typography--line--8) }
		}
	}
}
